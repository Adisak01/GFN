<!doctype html>
<html lang="th" class="h-full">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="apple-touch-icon" href="https://github.com/Adisak01/GFN/blob/main/letter-g.png?raw=true">
  <title>GeForce Now Rental Manager</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&amp;display=swap"
    rel="stylesheet">

  <style>
    body {
      box-sizing: border-box;
    }

    * {
      font-family: 'Kanit', sans-serif;
    }

    .gradient-bg {
      background: linear-gradient(135deg, #0f0f0f 0%, #1a1a2e 50%, #16213e 100%);
    }

    .card-glass {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .glow-green {
      box-shadow: 0 0 20px rgba(118, 185, 0, 0.3);
    }

    .glow-blue {
      box-shadow: 0 0 20px rgba(0, 149, 255, 0.3);
    }

    .scrollbar-thin::-webkit-scrollbar {
      width: 6px;
    }

    .scrollbar-thin::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.05);
    }

    .scrollbar-thin::-webkit-scrollbar-thumb {
      background: rgba(118, 185, 0, 0.5);
      border-radius: 3px;
    }

    @keyframes pulse-glow {

      0%,
      100% {
        box-shadow: 0 0 20px rgba(118, 185, 0, 0.3);
      }

      50% {
        box-shadow: 0 0 30px rgba(118, 185, 0, 0.5);
      }
    }

    .animate-glow {
      animation: pulse-glow 2s ease-in-out infinite;
    }
  </style>
</head>

<body class="h-full gradient-bg text-white">
  <div id="app" class="h-full overflow-auto scrollbar-thin">
    <header class="sticky top-0 z-50 bg-black/50 backdrop-blur-lg border-b border-white/10">
      <div class="max-w-7xl mx-auto px-4 py-4">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3">
            <div
              class="w-10 h-10 rounded-xl bg-gradient-to-br from-[#76b900] to-[#5a8f00] flex items-center justify-center glow-green">
              <svg class="w-6 h-6" viewbox="0 0 24 24" fill="white">
                <path
                  d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z" />
              </svg>
            </div>
            <div>
              <h1 id="app-title" class="text-xl font-bold text-[#76b900]">GeForce Now Rental</h1>
              <p class="text-xs text-gray-400">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏õ‡∏•‡πà‡∏≠‡∏¢‡πÄ‡∏ä‡πà‡∏≤ (Firebase Live)</p>
            </div>
          </div>
          <div class="flex items-center gap-2"><span class="text-xs text-gray-400" id="current-date"></span></div>
        </div>
      </div>
    </header>

    <nav class="max-w-7xl mx-auto px-4 py-4">
      <div class="flex gap-2">
        <button onclick="switchTab('income')" id="tab-income"
          class="tab-btn px-6 py-3 rounded-xl font-medium transition-all bg-[#76b900] text-black"> üí∞ ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö </button>
        <button onclick="switchTab('accounts')" id="tab-accounts"
          class="tab-btn px-6 py-3 rounded-xl font-medium transition-all bg-white/10 text-gray-300 hover:bg-white/20">
          üéÆ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÑ‡∏≠‡∏î‡∏µ </button>
      </div>
    </nav>

    <main class="max-w-7xl mx-auto px-4 pb-8">
      <div id="income-tab" class="space-y-6">
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
          <div class="card-glass rounded-2xl p-4 glow-green">
            <div class="text-gray-400 text-sm mb-1">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
            <div class="text-2xl font-bold text-[#76b900]" id="total-income">‡∏ø0</div>
          </div>
          <div class="card-glass rounded-2xl p-4">
            <div class="text-gray-400 text-sm mb-1">‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡πà‡∏≤</div>
            <div class="text-2xl font-bold text-white" id="total-hours">0 ‡∏ä‡∏°.</div>
          </div>
          <div class="card-glass rounded-2xl p-4">
            <div class="text-gray-400 text-sm mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
            <div class="text-2xl font-bold text-white" id="total-rentals">0</div>
          </div>
          <div class="card-glass rounded-2xl p-4">
            <div class="text-gray-400 text-sm mb-1">‡πÑ‡∏≠‡∏î‡∏µ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</div>
            <div class="text-2xl font-bold text-[#0095ff]" id="active-accounts">0</div>
          </div>
        </div>

        <div class="card-glass rounded-2xl p-6">
          <h3 class="text-lg font-semibold mb-4 flex items-center gap-2"><span class="text-[#76b900]">‚ûï</span>
            ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πà‡∏≤</h3>
          <form id="rental-form" class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div><label class="block text-sm text-gray-400 mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏≠‡∏î‡∏µ</label>
              <select id="rental-account"
                class="w-full px-4 py-3 rounded-xl bg-white/10 border border-white/20 text-gray-400 focus:outline-none focus:border-[#76b900]">
                <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏≠‡∏î‡∏µ --</option>
              </select>
            </div>
            <div><label class="block text-sm text-gray-400 mb-2">‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</label>
              <input type="text" id="customer-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤"
                class="w-full px-4 py-3 rounded-xl bg-white/10 border border-white/20 text-white placeholder-gray-500 focus:outline-none focus:border-[#76b900]">
            </div>
            <!-- <div><label class="block text-sm text-gray-400 mb-2">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</label>
              <input type="number" id="hours-rented" placeholder="‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á" min="1"
                class="w-full px-4 py-3 rounded-xl bg-white/10 border border-white/20 text-white placeholder-gray-500 focus:outline-none focus:border-[#76b900]">
            </div> -->
            <div><label class="block text-sm text-gray-400 mb-2">‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏ø)</label>
              <input type="number" id="rental-price" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤" min="0"
                class="w-full px-4 py-3 rounded-xl bg-white/10 border border-white/20 text-white placeholder-gray-500 focus:outline-none focus:border-[#76b900]">
            </div>
            <div><label class="block text-sm text-gray-400 mb-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡πà‡∏≤</label>
              <input type="datetime-local" id="rental-date"
                class="w-full px-4 py-3 rounded-xl bg-white/10 border border-white/20 text-white focus:outline-none focus:border-[#76b900]">
            </div>
            <div><label class="block text-sm text-gray-400 mb-2">‡πÄ‡∏ä‡πà‡∏≤‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
              <input type="datetime-local" id="end-date"
                class="w-full px-4 py-3 rounded-xl bg-white/10 border border-white/20 text-white focus:outline-none focus:border-[#76b900]">
            </div>
            <div class="md:col-span-3">
              <button type="submit"
                class="w-full py-3 rounded-xl bg-gradient-to-r from-[#76b900] to-[#5a8f00] text-black font-semibold hover:opacity-90 transition-all">
                ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ </button>
            </div>
          </form>
        </div>

        <div class="card-glass rounded-2xl p-6">
          <h3 class="text-lg font-semibold mb-4 flex items-center gap-2"><span class="text-[#76b900]">üìã</span>
            ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πà‡∏≤</h3>
          <div id="rental-list" class="space-y-3 max-h-96 overflow-y-auto  overflow-y-hidden overflow-x-hidden">
            <div class="text-center text-gray-500 py-8">
              <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
            </div>
          </div>
        </div>
      </div>

      <div id="accounts-tab" class="space-y-6 hidden">
        <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
          <div class="card-glass rounded-2xl p-4 glow-blue">
            <div class="text-gray-400 text-sm mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÑ‡∏≠‡∏î‡∏µ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
            <div class="text-2xl font-bold text-[#0095ff]" id="total-accounts">0</div>
          </div>
          <div class="card-glass rounded-2xl p-4">
            <div class="text-gray-400 text-sm mb-1">‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏£‡∏ß‡∏°</div>
            <div class="text-2xl font-bold text-white" id="remaining-hours">0 ‡∏ä‡∏°.</div>
          </div>
          <div class="card-glass rounded-2xl p-4">
            <div class="text-gray-400 text-sm mb-1">‡πÑ‡∏≠‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤</div>
            <div class="text-2xl font-bold text-red-400" id="expired-accounts">0</div>
          </div>
        </div>

        <div class="card-glass rounded-2xl p-6">
          <h3 class="text-lg font-semibold mb-4 flex items-center gap-2"><span class="text-[#0095ff]">üéÆ</span>
            ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏≠‡∏î‡∏µ</h3>
          <form id="account-form" class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div><label class="block text-sm text-gray-400 mb-2">Gmail</label>
              <input type="text" id="account-name" placeholder="‡πÄ‡∏ä‡πà‡∏ô xxx@gmail.com"
                class="w-full px-4 py-3 rounded-xl bg-white/10 border border-white/20 text-white focus:outline-none focus:border-[#0095ff]">
            </div>
            <div><label class="block text-sm text-gray-400 mb-2">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
              <input type="text" id="account-password" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô"
                class="w-full px-4 py-3 rounded-xl bg-white/10 border border-white/20 text-white focus:outline-none focus:border-[#0095ff]">
            </div>
            <div><label class="block text-sm text-gray-400 mb-2">‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</label>
              <input type="number" id="total-hours-input" placeholder="‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á" min="1"
                class="w-full px-4 py-3 rounded-xl bg-white/10 border border-white/20 text-white focus:outline-none focus:border-[#0095ff]">
            </div>
            <div class="flex items-end"><button type="submit"
                class="w-full py-3 rounded-xl bg-gradient-to-r from-[#0095ff] to-[#0077cc] text-white font-semibold hover:opacity-90 transition-all">
                ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏≠‡∏î‡∏µ </button></div>
          </form>
        </div>

        <div class="card-glass rounded-2xl p-6">
          <h3 class="text-lg font-semibold mb-4 flex items-center gap-2"><span class="text-[#0095ff]">üìÅ</span>
            ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏≠‡∏î‡∏µ</h3>
          <div id="account-list" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
        </div>
      </div>

      <div id="loading-overlay"
        class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50">
        <div class="bg-white/10 rounded-2xl p-6 flex items-center gap-3">
          <div class="w-6 h-6 border-2 border-[#76b900] border-t-transparent rounded-full animate-spin"></div>
          <span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£...</span>
        </div>
      </div>

      <div id="delete-modal"
        class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-99999">
        <div class="card-glass rounded-2xl p-6 max-w-sm mx-4">
          <h3 class="text-lg font-semibold mb-4">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö</h3>
          <p class="text-gray-400 mb-6">‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</p>
          <div class="flex gap-3">
            <button onclick="closeDeleteModal()"
              class="flex-1 py-2 rounded-xl bg-white/10 hover:bg-white/20 transition-all">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            <button id="confirm-delete-btn" class="flex-1 py-2 rounded-xl bg-red-500 hover:bg-red-600 transition-all"
              onclick="confirmDelete()">‡∏•‡∏ö</button>
          </div>
        </div>
      </div>

      <div id="edit-modal"
        class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50">
        <div class="card-glass rounded-2xl p-6 max-w-sm mx-4">
          <div class="flex gap-3">
            <div class="flex-1">
              <label class="block text-sm text-gray-400 mb-2">‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡πà‡∏≤</label>
              <input type="number" id="edit-hours-rented" placeholder="‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á" min="1"
                class="w-full px-4 py-3 rounded-xl bg-white/10 border border-white/20 text-white placeholder-gray-500 focus:outline-none focus:border-[#76b900]">
              <label class="block text-sm text-gray-400 mb-2 mt-4">‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏ø)</label>
              <input type="number" id="edit-rental-price" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤" min="0"
                class="w-full px-4 py-3 rounded-xl bg-white/10 border border-white/20 text-white placeholder-gray-500 focus:outline-none focus:border-[#76b900]">
              <label class="block text-sm text-gray-400 mb-2 mt-4">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:
                ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏™‡πà‡∏á‡∏ú‡∏•‡∏ï‡πà‡∏≠‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏Ç‡∏≠‡∏á‡πÑ‡∏≠‡∏î‡∏µ</label>
              <div class="flex gap-3 mt-4">
                <button onclick="closeEditModal()"
                  class="flex-1 py-2 rounded-xl bg-white/10 hover:bg-white/20 transition-all">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button id="confirm-delete-btn-edit"
                  class="flex-1 py-2 rounded-xl bg-red-500 hover:bg-red-600 transition-all" onclick="showDeleteModal()">
                  ‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
                <button id="confirm-edit-btn"
                  class="flex-1 py-2 rounded-xl bg-green-500 hover:bg-green-600 transition-all "
                  onclick="confirmEdit()">‡∏ï‡∏Å‡∏•‡∏á</button>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div id="edit-account-modal"
        class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50">
        <div class="card-glass rounded-2xl p-6 max-w-sm mx-4">
          <div class="flex gap-3">
            <div class="flex-1">
              <label class="block text-sm text-gray-400 mb-2">Email</label>
              <input type="email" id="edit-account-email" placeholder="Email" min="1"
                class="w-full px-4 py-3 rounded-xl bg-white/10 border border-white/20 text-white placeholder-gray-500 focus:outline-none focus:border-[#76b900]">

              <label class="block text-sm text-gray-400 mb-2 mt-4">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
              <input type="text" id="edit-account-password" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" min="1"
                class="w-full px-4 py-3 rounded-xl bg-white/10 border border-white/20 text-white placeholder-gray-500 focus:outline-none focus:border-[#76b900]">

              <label class="block text-sm text-gray-400 mb-2 mt-4">‡πÄ‡∏ß‡∏•‡∏≤‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ (‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á)</label>
              <input type="number" id="edit-account-hours-left" placeholder="‡πÄ‡∏ß‡∏•‡∏≤‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠" min="0"
                class="w-full px-4 py-3 rounded-xl bg-white/10 border border-white/20 text-white placeholder-gray-500 focus:outline-none focus:border-[#76b900]">

              <label class="block text-sm text-gray-400 mb-2 mt-4">‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á)</label>
              <input type="number" id="edit-account-total-hours" placeholder="‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" min="0"
                class="w-full px-4 py-3 rounded-xl bg-white/10 border border-white/20 text-white placeholder-gray-500 focus:outline-none focus:border-[#76b900]">

              <div class="flex gap-3 mt-4"> <button onclick="closeEditAccountModal()"
                  class="flex-1 py-2 rounded-xl bg-white/10 hover:bg-white/20 transition-all">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button id="confirm-delete-account-btn"
                  class="flex-1 py-2 rounded-xl bg-red-500 hover:bg-red-600 transition-all "
                  onclick="confirmDeleteAccount()">‡∏•‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</button>
                <button id="confirm-edit-account-btn"
                  class="flex-1 py-2 rounded-xl bg-green-500 hover:bg-green-600 transition-all "
                  onclick="confirmEditAccount()">‡∏ï‡∏Å‡∏•‡∏á</button>
              </div>
            </div>
          </div>
        </div>

      </div>
    </main>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    // TODO: REPLACE WITH YOUR CONFIG
    const firebaseConfig = {
      apiKey: "AIzaSyAiFMrxHtoJhqJpqj4zGCITbgXF1maeIHs",
      authDomain: "gfn0-1b9e1.firebaseapp.com",
      databaseURL: "https://gfn0-1b9e1-default-rtdb.firebaseio.com",
      projectId: "gfn0-1b9e1",
      storageBucket: "gfn0-1b9e1.firebasestorage.app",
      messagingSenderId: "673141288107",
      appId: "1:673141288107:web:302aeb9b9c35eed0dbdbee",
      measurementId: "G-N6CKK95XFQ"
    };


    const firebaseApp = initializeApp(firebaseConfig);
    const db = getFirestore(firebaseApp);
    const dataCol = collection(db, "gfn_rentals");

    // Bridge Firebase to the existing UI logic
    window.dataSdk = {
      async init(handler) {
        onSnapshot(dataCol, (snapshot) => {
          const data = snapshot.docs.map(d => ({ ...d.data(), __backendId: d.id }));
          handler.onDataChanged(data);
        });
        return { isOk: true };
      },
      async create(payload) {
        try { await addDoc(dataCol, payload); return { isOk: true }; }
        catch (e) { return { isOk: false }; }
      },
      async update(payload) {
        try {
          const docRef = doc(db, "gfn_rentals", payload.__backendId);
          const updateData = { ...payload };
          delete updateData.__backendId;
          await updateDoc(docRef, updateData);
          return { isOk: true };
        } catch (e) { return { isOk: false }; }
      },
      async delete(payload) {
        try { await deleteDoc(doc(db, "gfn_rentals", payload.__backendId)); return { isOk: true }; }
        catch (e) { return { isOk: false }; }
      }
    };

    // Trigger local init after Firebase bridge is ready
    if (window.localInit) window.localInit();
  </script>

  <script>
    let allData = [];
    let pendingDeleteRecord = null;

    // UI Helpers
    function switchTab(tab) {
      document.getElementById('income-tab').classList.toggle('hidden', tab !== 'income');
      document.getElementById('accounts-tab').classList.toggle('hidden', tab !== 'accounts');
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('bg-[#76b900]', 'text-black');
        btn.classList.add('bg-white/10', 'text-gray-300');
      });
      const activeBtn = document.getElementById(`tab-${tab}`);
      activeBtn.classList.add('bg-[#76b900]', 'text-black');
    }

    function showLoading() { document.getElementById('loading-overlay').classList.remove('hidden'); }
    function hideLoading() { document.getElementById('loading-overlay').classList.add('hidden'); }
    function showToast(m, type = 'success') {
      const t = document.createElement('div');
      t.className = `fixed bottom-4 left-1/2 -translate-x-1/2 px-6 py-3 rounded-xl z-50 ${type === 'error' ? 'bg-red-500' : 'bg-[#76b900]'} text-white`;
      t.textContent = m;
      document.body.appendChild(t);
      setTimeout(() => t.remove(), 3000);
    }

    function showEditModal(record) {
      pendingEditRecord = record;
      document.getElementById('edit-modal').classList.remove('hidden');
      document.getElementById('edit-hours-rented').value = record.hours_rented || 0;
      document.getElementById('edit-rental-price').value = record.price || 0;
    }
    function showEditAccountModal(record) {
      pendingEditRecord = record;
      document.getElementById('edit-account-modal').classList.remove('hidden');
      document.getElementById('edit-account-email').value = record.account_name || '';
      document.getElementById('edit-account-password').value = record.account_password || '';
      document.getElementById('edit-account-hours-left').value = record.remaining_hours || 0;
      document.getElementById('edit-account-total-hours').value = record.total_hours || 0;
    }
    let pendingEditRecord = null;
    function confirmEdit() {
      const newHours = parseInt(document.getElementById('edit-hours-rented').value) || 0;
      const newPrice = parseInt(document.getElementById('edit-rental-price').value) || 0;
      if (pendingEditRecord) {
        showLoading();
        showToast(`Update Complete`);
        window.dataSdk.update({ ...allData.find(a => a.__backendId === pendingEditRecord.account_id), remaining_hours: allData.find(a => a.__backendId === pendingEditRecord.account_id)?.remaining_hours - newHours }).then(() => {
        });
        window.dataSdk.update({ ...pendingEditRecord, hours_rented: newHours, price: newPrice }).then(() => {
          hideLoading();
          closeEditModal();
        });

      }
    }

    function confirmDelete() {
      if (pendingEditRecord) {

        showLoading();
        window.dataSdk.update({ ...pendingEditRecord, status: 0 }).then(() => {
          hideLoading();
          closeDeleteModal();
          showToast('Delete Complete');
        });
      }
    }

    function showDeleteModal(record) {
      document.getElementById('delete-modal').classList.remove('hidden');
      document.getElementById('edit-modal').classList.add('hidden');
    }

    function closeDeleteModal() {
      document.getElementById('delete-modal').classList.add('hidden');
    }
    function confirmDeleteAccount() {
      if (pendingDeleteRecord) {
        showLoading();
        window.dataSdk.delete(pendingDeleteRecord).then(() => {
          hideLoading();
          closeDeleteModal();
        });
      }
    }
    function confirmEditAccount() {
      const newEmail = document.getElementById('edit-account-email').value;
      const newPassword = document.getElementById('edit-account-password').value;
      const newHoursLeft = parseInt(document.getElementById('edit-account-hours-left').value) || 0;
      const newTotalHours = parseInt(document.getElementById('edit-account-total-hours').value) || 0;
      if (pendingEditRecord) {
        showLoading();
        window.dataSdk.update({ ...pendingEditRecord, account_name: newEmail, account_password: newPassword, remaining_hours: newHoursLeft, total_hours: newTotalHours }).then(() => {
          hideLoading();
          closeEditAccountModal();
        });
      }
    }
    function closeEditAccountModal() {
      document.getElementById('edit-account-modal').classList.add('hidden');
    }

    function closeDeleteModal() {
      document.getElementById('delete-modal').classList.add('hidden');
    }
    function closeEditModal() {
      document.getElementById('edit-modal').classList.add('hidden');
    }

    // Data Change Handler
    const dataHandler = {
      onDataChanged(data) {
        allData = data;
        const rentals = data.filter(d => d.type === 'rental');
        const accounts = data.filter(d => d.type === 'account');

        // Stats
        const income = rentals.reduce((s, r) => s + (r.price || 0), 0);
        const hours = rentals.reduce((s, r) => s + (r.hours_rented || 0), 0);
        const remHours = accounts.reduce((s, a) => s + (a.remaining_hours || 0), 0);

        document.getElementById('total-income').textContent = `‡∏ø${income.toLocaleString()}`;
        document.getElementById('total-hours').textContent = `${hours} ‡∏ä‡∏°.`;
        document.getElementById('total-rentals').textContent = rentals.length;
        document.getElementById('active-accounts').textContent = accounts.filter(a => a.remaining_hours > 0).length;
        document.getElementById('total-accounts').textContent = accounts.length;
        document.getElementById('remaining-hours').textContent = `${remHours} ‡∏ä‡∏°.`;
        document.getElementById('expired-accounts').textContent = accounts.filter(a => a.remaining_hours <= 0).length;

        // Account Dropdown
        const sel = document.getElementById('rental-account');
        const cur = sel.value;
        sel.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏≠‡∏î‡∏µ --</option>';
        accounts.forEach(acc => {
          const opt = document.createElement('option');
          opt.value = acc.__backendId;
          opt.textContent = `${acc.account_name} (${acc.remaining_hours} ‡∏ä‡∏°.)`;
          if (acc.remaining_hours <= 0) opt.disabled = true;
          sel.appendChild(opt);
        });
        sel.value = cur;

        renderRentals(rentals, accounts);
        renderAccounts(accounts);
      }
    };

    function renderRentals(rentals, accounts) {
      const container = document.getElementById('rental-list');
      if (!rentals.length) { container.innerHTML = '<p class="text-center py-8 text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>'; return; }

      container.innerHTML = rentals.sort((a, b) => new Date(b.rental_date) - new Date(a.rental_date)).map(r => {
        const acc = accounts.find(a => a.__backendId === r.account_id);
        if (r.status === 0) {

        } else {
          return `
          <div class="bg-white/5 rounded-xl p-4 border border-white/10 flex justify-between items-center hover:bg-white/10 transition-all hover:shadow-md hover:shadow-[#76b900]/20 hover:scale-[1.01]  hover:animate-glow hover:cursor-pointer " onclick='showEditModal(${JSON.stringify(r)})'>
            <div>
              <div class="flex gap-2 mb-1">
                <span class="text-[#76b900] text-xs font-bold">${acc?.account_name || 'N/A'}</span>
                <span class="text-gray-300 text-xs">${r.customer_name}</span>
              </div>
              <div class="text-sm text-gray-400">${r.hours_rented} ‡∏ä‡∏°. | ‡∏ø${r.price} | ${new Date(r.rental_date).toLocaleString('th-TH')} - ${new Date(r.end_date).toLocaleString('th-TH')} </div>
            </div>
          </div>
        `;
        }
      }
      ).join('');
    }

    function renderAccounts(accounts) {
      const container = document.getElementById('account-list');
      container.innerHTML = accounts.map(a => {
        const perc = a.total_hours > 0 ? (a.remaining_hours / a.total_hours) * 100 : 0;
        return `
          <div class="card-glass p-4 rounded-xl border ${a.remaining_hours <= 0 ? 'border-red-500/50' : 'border-white/10'} hover:shadow-md hover:shadow-[#0095ff]/20 hover:scale-[1.01] transition-all cursor-pointer" onclick='showEditAccountModal(${JSON.stringify(a)})'>
            <div class="flex justify-between mb-2">
              <div class="flex flex-col">
                <span class="">Email : ${a.account_name}</span>
                <span class="">Password :  ${a.account_password}</span>
              </div>
            </div>
            <div class="text-xs text-gray-400 mb-1">‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${a.remaining_hours}/${a.total_hours} ‡∏ä‡∏°.</div>
            <div class="h-1.5 w-full bg-white/10 rounded-full overflow-hidden">
              <div class="h-full ${a.remaining_hours <= 10 ? 'bg-yellow-500' : a.remaining_hours <= 0 ? 'bg-red-500' : 'bg-[#0095ff]'}" style="width:${perc}%" ></div>
            </div>
            <div class="flex gap-2 mt-3">
              <button onclick="addHours('${a.__backendId}', 10)" class="flex-1 text-[10px] bg-white/5 py-1 rounded">+10</button>
              <button onclick="addHours('${a.__backendId}', 50)" class="flex-1 text-[10px] bg-white/5 py-1 rounded">+50</button>
            </div>
          </div>
        `;
      }).join('');
    }

    async function addHours(id, h) {
      const acc = allData.find(d => d.__backendId === id);
      if (acc) {
        showLoading();
        await window.dataSdk.update({ ...acc, remaining_hours: acc.remaining_hours + h, total_hours: acc.total_hours + h });
        hideLoading();
      }
    }

    // Form Submissions
    document.getElementById('rental-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const accId = document.getElementById('rental-account').value;
      // const hours = parseInt(document.getElementById('hours-rented').value);
      const acc = allData.find(a => a.__backendId === accId);

      if (!accId) return showToast("‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö", "error");
      // if (acc.remaining_hours < hours) return showToast("‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡πÑ‡∏°‡πà‡∏û‡∏≠", "error");

      showLoading();
      const payload = {
        type: 'rental',
        account_id: accId,
        customer_name: document.getElementById('customer-name').value,
        hours_rented: 0,
        price: parseInt(document.getElementById('rental-price').value) || 0,
        rental_date: document.getElementById('rental-date').value,
        end_date: document.getElementById('end-date').value,
        status: 1,
      };

      const res = await window.dataSdk.create(payload);
      if (res.isOk) {
        await window.dataSdk.update({ ...acc, remaining_hours: acc.remaining_hours - 0 });
        e.target.reset();
        showToast("‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
      } else {
        showToast("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", "error");
        hideLoading();
      }
      hideLoading();
    });

    document.getElementById('account-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const name = document.getElementById('account-name').value;
      const password = document.getElementById('account-password').value;
      const hours = parseInt(document.getElementById('total-hours-input').value);
      if (!name || !hours) return;

      showLoading();
      await window.dataSdk.create({
        type: 'account',
        account_name: name,
        account_password: password,
        total_hours: hours,
        remaining_hours: hours
      });
      e.target.reset();
      hideLoading();
    });

    // Initialize
    window.localInit = async () => {
      document.getElementById('current-date').textContent = new Date().toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric' });
      const now = new Date().toISOString().slice(0, 16);
      document.getElementById('rental-date').value = now;
      await window.dataSdk.init(dataHandler);
    };
  </script>
</body>

</html>